{% extends 'base.html' %}
{% load static %}
{% block title %}Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø§Ù„ÛŒ | ÙØ±ÙˆØ´Ú¯Ø§Ù‡ ØªØ±Ø§Ø¨ÛŒ{% endblock %}
{% load humanize %}

{% block content %}
<div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg p-8 mt-8 text-base text-gray-800">
  <h2 class="text-2xl font-extrabold text-gray-900 border-b pb-4 mb-6 text-center">ğŸ’³ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ù…Ø§Ù„ÛŒ Ù…Ù†</h2>

  <!-- ğŸ“Š Ù†Ù…ÙˆØ¯Ø§Ø± Ø¨Ø¯Ù‡ÛŒ Ùˆ Ù¾Ø±Ø¯Ø§Ø®Øª -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <div class="my-10">
    <h3 class="text-lg font-semibold text-gray-900 mb-4">ğŸ“Š ÙˆØ¶Ø¹ÛŒØª Ø¨Ø¯Ù‡ÛŒ Ùˆ Ù¾Ø±Ø¯Ø§Ø®Øª</h3>
    <canvas id="debtChart" class="max-w-xs mx-auto"></canvas>
  </div>

  <!-- Ø¨Ø¯Ù‡ÛŒ Ø¬Ø§Ø±ÛŒ -->
  {% if debt %}
    <div class="bg-red-100 border border-red-300 text-red-700 p-4 rounded-lg mb-6 shadow-sm">
      Ø¨Ø¯Ù‡ÛŒ Ø¬Ø§Ø±ÛŒ Ø´Ù…Ø§: <strong>{{ debt.total_debt|intcomma }} ØªÙˆÙ…Ø§Ù†</strong>
      <span class="block text-sm mt-2">Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ: {{ debt.updated_at|date:"Y/m/d" }}</span>
    </div>
  {% else %}
    <div class="bg-green-100 border border-green-300 text-green-700 p-4 rounded-lg mb-6 shadow-sm">
      âœ… Ø´Ù…Ø§ Ù‡ÛŒÚ† Ø¨Ø¯Ù‡ÛŒ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡â€ŒØ§ÛŒ Ù†Ø¯Ø§Ø±ÛŒØ¯
    </div>
  {% endif %}

  <!-- ÙØ±Ù… Ø«Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù¾Ø±Ø¯Ø§Ø®Øª -->
  <div class="mb-10">
    <h3 class="text-lg font-semibold text-gray-900 mb-4">ğŸ“ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù¾Ø±Ø¯Ø§Ø®Øª Ø¨Ø¯Ù‡ÛŒ</h3>
    <form method="post" enctype="multipart/form-data" class="grid gap-6">
      {% csrf_token %}

      <div>
        <label for="id_amount" class="block mb-2 font-medium text-gray-700">ğŸ’° Ù…Ø¨Ù„Øº Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ:</label>
        {{ form.amount }}
        <script>
          document.getElementById('id_amount')?.classList.add(
            'w-full', 'px-4', 'py-2', 'border', 'border-black',
            'rounded-lg', 'bg-white', 'shadow-sm', 'focus:outline-none',
            'focus:ring-2', 'focus:ring-red-400', 'transition'
          );
        </script>
      </div>

      <div>
        <label for="id_description" class="block mb-2 font-medium text-gray-700">ğŸ“ ØªÙˆØ¶ÛŒØ­Ø§Øª:</label>
        {{ form.description }}
        <script>
          document.getElementById('id_description')?.classList.add(
            'w-full', 'px-4', 'py-2', 'border', 'border-black',
            'rounded-lg', 'bg-white', 'shadow-sm', 'focus:outline-none',
            'focus:ring-2', 'focus:ring-blue-400', 'transition'
          );
        </script>
      </div>

      <div>
        <label for="id_payment_receipt" class="block mb-2 font-medium text-gray-700">ğŸ“ ØªØµÙˆÛŒØ± ÙÛŒØ´ Ù¾Ø±Ø¯Ø§Ø®Øª:</label>
        {{ form.payment_receipt }}
        <script>
          document.getElementById('id_payment_receipt')?.classList.add(
            'w-full', 'px-4', 'py-2', 'border', 'border-black',
            'rounded-lg', 'bg-white', 'shadow-sm', 'focus:outline-none',
            'focus:ring-2', 'focus:ring-blue-400', 'transition'
          );
        </script>
      </div>

      <div>
        <label for="id_reference_number" class="block mb-2 font-medium text-gray-700">ğŸ”¢ Ø´Ù…Ø§Ø±Ù‡ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ:</label>
        {{ form.reference_number }}
        <script>
          document.getElementById('id_reference_number')?.classList.add(
            'w-full', 'px-4', 'py-2', 'border', 'border-black',
            'rounded-lg', 'bg-white', 'shadow-sm', 'focus:outline-none',
            'focus:ring-2', 'focus:ring-purple-400', 'transition'
          );
        </script>
      </div>

      <button type="submit"
        class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-3 rounded-full font-bold shadow-lg transition">
        ğŸ“¤ Ø«Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª
      </button>
    </form>
  </div>

  <!-- Ù„ÛŒØ³Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡ -->
  <div>
    <h3 class="text-lg font-semibold text-gray-900 mb-4">ğŸ“‹ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù¾Ø±Ø¯Ø§Ø®Øª Ù…Ù†</h3>
    {% if requests %}
      <ul class="space-y-6 text-sm">
        {% for req in requests %}
          <li class="p-4 rounded-lg border shadow-sm bg-gray-50">
            <div class="flex justify-between items-center">
              <span>ğŸ’° Ù…Ø¨Ù„Øº: <strong>{{ req.amount|intcomma }} ØªÙˆÙ…Ø§Ù†</strong></span>
              <span>ğŸ“… Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡ Ø¯Ø± {{ req.created_at|date:"Y/m/d" }}</span>
            </div>
            <div class="mt-2">ÙˆØ¶Ø¹ÛŒØª:
              {% if req.status == 'approved' %}
                <span class="text-green-600 font-bold">ØªØ£ÛŒÛŒØ¯ Ø´Ø¯Ù‡</span>
              {% elif req.status == 'rejected' %}
                <span class="text-red-600 font-bold">Ø±Ø¯ Ø´Ø¯Ù‡</span>
              {% else %}
                <span class="text-yellow-600 font-bold">Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ø¨Ø±Ø±Ø³ÛŒ</span>
              {% endif %}
            </div>
            {% if req.reference_number %}
              <div class="mt-1 text-gray-600">ğŸ”¢ Ø´Ù…Ø§Ø±Ù‡ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ: {{ req.reference_number }}</div>
            {% endif %}
            {% if req.payment_receipt %}
              <div class="mt-2">
                <img src="{{ req.payment_receipt.url }}" alt="ÙÛŒØ´ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒ" class="w-40 border border-gray-400 rounded-lg shadow-sm" />
              </div>
            {% endif %}
            {% if req.description %}
              <p class="mt-2 text-gray-700">ğŸ“ ØªÙˆØ¶ÛŒØ­Ø§Øª: {{ req.description }}</p>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    {% else %}
      <p class="text-gray-500">Ù‡Ù†ÙˆØ² Ù‡ÛŒÚ† Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯ÛŒØ¯.</p>
    {% endif %}
  </div>
</div>

<!-- ğŸ“Š Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ù†Ù…ÙˆØ¯Ø§Ø± -->
<script>
  const ctx = document.getElementById('debtChart')?.getContext('2d');
  if (ctx) {
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Ù¾Ø±Ø¯Ø§Ø®Øªâ€ŒØ´Ø¯Ù‡', 'Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡ Ø¨Ø¯Ù‡ÛŒ'],
        datasets: [{
          data: [{{ total_paid|default:"0" }}, {{ total_debt|default:"0"|floatformat:0 }}],
          backgroundColor: ['#10b981', '#ef4444'],
          borderWidth: 1
        }]
      },
      options: {
        plugins: { legend: { position: 'bottom' } },
        responsive: true
      }
    });
  }
</script>
{% endblock %}
